{% extends '::base.html.twig' %}

{% block body -%}

<h1>Statut</h1>
<div id="progressbar" style="margin-left: 130px; margin-top: -45px; margin-bottom: 20px; width: 50%; "></div>

{#
<div class="row">
{% for team in teams %}
    <div class="col-xs-6 col-sm-3 team-color-grad-{{ team.id }}">
        <div class="timing-status-teams" id="timing-status-team-{{ team.id }}">Statut de {{ team.name }}</div>
        <div id="timing-manual-team-{{ team.id }}">
            <select class="team-racer-manual-selector" name="team-{{ team.id }}-racer-id">
                <option></option>
{% for racer in team.racers %}
                <option value="racer.id">
                    {{ racer.nickname }}
                </option>
{% endfor %}
            </select>
            <button class="btn btn-primary">Ajouter un tour</button>
        </div>
    </div>
{% endfor %}
</div>
#}

<div class="">
<table class="table table-condensed table-stripped table-bordered table-hover">
    <thead>
        <tr>
            <th>Fini</th>
            <th>Fini</th>
            <th>Vient de finir</th>
            <th><span id="remains"></span></th>
            <th>Sur la piste</th>
            <th>Doit se préparer</th>
            <th>A encore le temps</th>
            <th>--</th>
            <th>--</th>
        </tr>
    </thead>
    <tbody id="racers-prevision">
{% for team in teams %}
        <tr class="timing-status-teams" id="timing-status-team-{{ team.id }}">
            <td colspan="9" class="team-bg-color-{{ team.id }}">Chargement en cours</td>
        </tr>
{% endfor %}
    </tbody>
</table>
</div>

<div style="display: none;">
{% for team in teams %}
    <div id="selector-team-{{ team.id }}">
        <select class="team-racer-manual-selector" name="team-{{ team.id }}-racer-id">
            <option>Changer de coureur</option>
{% for racer in team.racers %}
            <option value="{{ racer.id }}">{{ racer.nickname }}</option>
{% endfor %}
        </select>
    </div>
{% endfor %}

</div>
{% endblock %}


{% block javascripts %}

<script>
$(document).ready(function() {
    loadTeam = function(selector, url) {
        $selector = $(selector);
        $selector.find('.clock').countdown('destroy');
        $selector.load(url, function() {
            $this = $(this);
            $clock = $this.find('.clock');

            var clockOptions = {
                compact: true
            }
            var arrival = new Date($clock.data('arrival'));

            if(arrival < new Date()) {
                /**
                 * il est déjà censé être arrivé
                 */
                clockOptions.since = arrival;
            } else {
                /**
                 * pas encore arrivé
                 */
                clockOptions.until = arrival;
            }
            $clock.countdown(clockOptions);
        });
    }
{% for team in teams %}
    loadTeam("#timing-status-team-{{ team.id }}", "{{ path('timing_status_team', { 'id': team.id }) }}");
{% endfor %}

    setInterval(function() {
        //initialDataSelector.html(initialData);
        setCountdown();
{% for team in teams %}
        loadTeam("#timing-status-team-{{ team.id }}", "{{ path('timing_status_team', { 'id': team.id }) }}");
{% endfor %}
    }, 30000);


    var remains = $('#remains');
    var progressbar = $('#progressbar');
    disableButtons = function(periods) {
        secPeriods = $.countdown.periodsToSeconds(periods);
        if(secPeriods >= 10) {
            progressbar.progressbar('value', secPeriods - 10);
        }
        if(secPeriods === 10) {
            progressbar.progressbar('value', false);
            $('#racers-prevision button').hide(); //addClass('btn-error');
        }
    }
    progressbar.progressbar({
        max: 20,
        value: 20,
    });

    setCountdown = function() {
        remains.countdown('destroy');
        remains.countdown({
            until: '+30',
            compact: true,
            format: 'MS',
            onTick: disableButtons
        });
    }
    //setInterval(setCountdown, 30000);
    setCountdown();

    racerPrevisons = $('#racers-prevision');
    racerPrevisons.on('click', 'button.prediction-changer, button.previous-changer', function() {
        var $button = $(this);
        var $parent = $button.parent();
        var $teamId = $button.data('team-id');
        var $racerId = $button.data('racer-id');
        var $select = $('#selector-team-' + $teamId + ' select');
        $parent.append($select);
        $parent.find('select option[value=' + $racerId + ']').attr('selected', 'selected');
    });
    racerPrevisons.on('change', 'select.team-racer-manual-selector', function() {
        var $select = $(this);
        var $selectedRacerId = $select.val();
        var $button = $select.parent().find('button');
        var $modificationType = $button.data('type');

        var postData = [];
        var $teamId = $button.data('team-id');

        if($modificationType == 'prediction') {
            var $pos = $button.data('prediction-pos');
            postData.push({
                racerid: $selectedRacerId,
                pos: $pos
            });
            $select.parent().prevUntil(
                document.getElementById('separator-' + $teamId),
                'td'
            ).each(function(index) {
                $td = $(this);
                $button = $td.find('button');
                $racerId = $button.data('racer-id');
                $position = $button.data('prediction-pos');
                postData.push({
                    racerid: $racerId,
                    pos: $position
                });
            });
            var postUrl = '{{ path("timing_update_prediction") }}';
        } else if ($modificationType == 'timing') {
            timingId = $button.data('timing');
            postData.push({
                racerid: $selectedRacerId,
                timing: timingId
            });
            var postUrl = '{{ path("timing_update_data") }}';
        } else {
            return;
        }

        $.post(
            postUrl,
            { data: postData, teamId: $teamId },
            function(data, textStatus, jqXHR) {
                window.location = window.location;
            }
        );
    });

    // passage manual des coureurs
    racerPrevisons.on('click', 'button.add-manual', function() {
        var $button = $(this);
        var $parent = $button.parent();
        var $teamId = $button.data('team-id');
        var $racerId = $button.data('racer-id');
        var postData = {};
        postData.racerid = $racerId;
        postData.teamid = $teamId;
        console.log(postData);
        $.post(
            '{{ path("timing_add_manual") }}',
            { data: postData },
            function(data, textStatus, jqXHR) {
                window.location = window.location;
            }
        );
    });
    //$('.team-racer-manual-selector').selectmenu();
});
</script>
{% endblock %}

{% block stylesheets %}
<link rel="{{ asset('jqcountdown/jquery.countdown.css') }}" />
{% endblock %}
